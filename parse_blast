#!/usr/bin/python
# coding=utf-8
#
# Copyright (C) 2012 Allis Tauri <allista@gmail.com>
# 
# indicator_gddccontrol is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
# 
# indicator_gddccontrol is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License along
# with this program.  If not, see <http://www.gnu.org/licenses/>.
'''
Created on Jun 23, 2012

parse_blast â€” which parses previously saved blast xml output and produses human 
readable report. The original NCBI BLAST txt reports are more informative though.

@author: Allis Tauri <allista@gmail.com>
'''    

#imports
import sys
import argparse
#try:
#    from Bio.Blast import NCBIXML
#except:
#    print "The BioPython must be installed in your system for this script to work."
#    sys.exit(1)

from DegenPrimer.Blast import Blast
#from DegenPrimer.StringTools import print_exception

#parse command line arguments
parser = argparse.ArgumentParser(description='Parse blast results in xml format and write human readable report.')
parser.add_argument('blast_results', metavar='filename.xml',
                    type=str, nargs='+',
                    help='File with blast results in xml format')
#in silica PCR
iPCR_group = parser.add_argument_group('BLAST results filtration and in silica PCR simulation')
iPCR_group.add_argument('--min-amplicon', metavar='bp', 
                    required=False, type=int, default=50,
                    help='Minimum amplicon size (default 50)')
iPCR_group.add_argument('--max-amplicon', metavar='bp', 
                    required=False, type=int, default=3000,
                    help='Maximum amplicon size (default 3000)')
iPCR_group.add_argument('--max-mismatches', metavar='b', 
                    required=False, type=int, default=3,
                    help='Maximum number of mismatches between a primer '
                    'and a target sequence (default 3).')
iPCR_group.add_argument('--no-exonuclease', default=False, 
                    required=False, action='store_true', 
                    help="Set this flag if you are planning to use a "
                    "DNA-polymerase without 3'-5'-exonuclease activity.")
args = parser.parse_args()


for blast_result in args.blast_results:
    #set job_id
    xml_filename = blast_result
    if   xml_filename.rfind('-blast.xml'): 
        job_id = xml_filename[0:xml_filename.rfind('-blast.xml')]
    elif xml_filename.rfind('.xml'): 
        job_id = xml_filename[0:xml_filename.rfind('.xml')]
    else: job_id = xml_filename

    #parse blast results
    blast = Blast(job_id)
    #load blast results
    blast.load_results()
    #report results in human readable form
    blast.write_hits_report(args.max_mismatches, 
                            args.no_exonuclease)
    blast.write_PCR_report(args.min_amplicon, 
                           args.max_amplicon, 
                           args.max_mismatches, 
                           args.no_exonuclease)
###
sys.exit(0)